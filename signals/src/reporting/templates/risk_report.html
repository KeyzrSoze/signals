<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Signals: Weekly Executive Risk Brief</title>
    <!-- Bootstrap 5.3 CDN -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
    <style>
        body {
            background-color: #f8f9fa;
        }
        .header {
            background-color: #343a40;
            color: white;
            padding: 2rem 0;
            margin-bottom: 2rem;
        }
        .card-header {
            font-weight: bold;
        }
        .section {
            margin-bottom: 2.5rem;
        }
        .table-container {
            max-height: 400px;
            overflow-y: auto;
        }
        .img-fluid {
            border: 1px solid #dee2e6;
            border-radius: .375rem;
            padding: 5px;
        }
    </style>
</head>
<body>
    <div class="header text-center">
        <div class="container">
            <h1 class="display-5">Signals: Weekly Executive Risk Brief</h1>
            <p class="lead">Automated Supply Chain Intelligence Report</p>
        </div>
    </div>

    <div class="container">
        <!-- System Status Section -->
        <div class="section" id="status">
            <div class="card">
                <div class="card-header">
                    System Status
                </div>
                <div class="card-body">
                    <p class="card-text"><strong>Report Generated On:</strong> {{ report_date }}</p>
                    
                    {# This block will only appear if the data_is_stale variable is True #}
                    {% if data_is_stale %}
                    <div class="alert alert-warning" role="alert">
                        <strong>Warning:</strong> The underlying feature data is more than 24 hours old. This report may not reflect the latest market conditions.
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>

        <!-- Top Critical Risks Table -->
        <div class="section" id="critical-risks">
            <h2 class="mb-3">Top Critical Risks</h2>
            <div class="card">
                <div class="card-header">
                    Highest Probability Price Spikes (Next 12 Weeks)
                </div>
                <div class="card-body table-container">
                    <table class="table table-striped table-hover">
                        <thead class="table-dark sticky-top">
                            <tr>
                                <th scope="col">Drug/NDC</th>
                                <th scope="col">Manufacturer</th>
                                <th scope="col">Reason</th>
                                <th scope="col">Risk Score (0-10)</th>
                            </tr>
                        </thead>
                        <tbody>
                            {# This loop will populate the table rows from a list of risk objects #}
                            {% for risk in top_risks %}
                            <tr>
                                <td>{{ risk.drug_name }}</td>
                                <td>{{ risk.manufacturer }}</td>
                                <td>{{ risk.risk_type }}</td>
                                <td><span class="badge bg-danger">{{ risk.score }}</span></td>
                            </tr>
                            {% else %}
                            <tr>
                                <td colspan="4" class="text-center">No critical risks identified.</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Visual Analysis Section -->
        <div class="section" id="visual-analysis">
            <h2 class="mb-3">Visual Analysis</h2>
            <div class="card">
                <div class="card-header">
                    Temporal Fusion Transformer: Forecast vs. Actuals
                </div>
                <div class="card-body text-center">
                    <p class="card-text">The chart below shows the forecasted price tunnel (P10-P90) against the actual price for a high-risk NDC.</p>
                    
                    {# This placeholder will be replaced with the Base64 encoded image #}
                    {% if embedded_image_base64 %}
                        <img src="data:image/png;base64,{{ embedded_image_base64 }}" class="img-fluid" alt="TFT Forecast Plot">
                    {% else %}
                        <div class="alert alert-info">Visual analysis image not available.</div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    <!-- Bootstrap 5.3 JS Bundle -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz" crossorigin="anonymous"></script>
</body>
</html>
